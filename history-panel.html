<!--
@license
Copyright 2018 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/utils/render-status.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../bottom-sheet/bottom-sheet.html">
<link rel="import" href="../saved-request-detail/saved-request-detail.html">
<link rel="import" href="../saved-request-editor/saved-request-editor.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../requests-list-mixin/requests-list-mixin.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../history-list-mixin/history-list-mixin.html">
<link rel="import" href="history-panel-list.html">

<dom-module id="history-panel">
  <template>
    <style>
    :host {
      display: block;
      position: relative;
      @apply --layout-vertical;
      @apply --history-panel;
    }

    [hidden] {
      display: none !important;
    }

    .header {
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    h2 {
      @apply --arc-font-headline;
      @apply --layout-flex;
    }

    h3 {
      @apply --arc-font-subhead;
    }

    paper-listbox iron-icon {
      color: rgba(0, 0, 0, 0.54);
    }

    paper-progress {
      width: 100%;
      @apply --history-panel-loader;
    }

    history-panel-list {
      overflow: auto;
    }

    .revert-button {
      height: 38px;
      @apply --history-panel-toast-revert-button;
    }

    #dataClearDialog {
      background-color: var(--warning-primary-color, #FF7043);
      color: var(--warning-contrast-color, #fff);
    }

    #dataClearDialog paper-button {
      color: #fff;
      background-color: transparent;
    }

    .error-toast {
      background-color: var(--warning-primary-color, #FF7043);
      color: var(--warning-contrast-color, #fff);
      @apply --error-toast;
    }

    .empty-info {
      font-size: 16px;
      @apply --empty-info;
    }

    #requestDetailsContainer,
    #requestEditorContainer {
      min-width: 40%;
      max-width: 60%;
      left: 20%;
      @apply --history-panel-bottom-sheet;
    }

    #requestDetailsContainer paper-fab {
      position: absolute;
      right: 16px;
      top: -28px;
      --paper-fab-background: var(--history-panel-fab-background-color, var(--primary-color));
    }

    .selection-options {
      @apply --layout-horizontal;
      @apply --layout-center;
      height: 56px;
    }

    .spacer {
      @apply --layout-flex;
    }
    </style>
    <div class="header">
      <h2>History</h2>
      <div class="header-actions">
        <paper-menu-button dynamic-align id="mainMenu">
          <paper-icon-button icon="arc:more-vert" slot="dropdown-trigger"></paper-icon-button>
          <paper-listbox slot="dropdown-content" id="mainMenuOptions">
            <paper-icon-item on-click="_onExportAll">
              <iron-icon icon="arc:archive" slot="item-icon"></iron-icon>
              Export all to file
            </paper-icon-item>
            <paper-icon-item on-click="_onExportAllDrive" data-action="export-selected-drive">
              <iron-icon icon="arc:drive-color" slot="item-icon"></iron-icon>
              Export all to Google Drive
            </paper-icon-item>
            <paper-icon-item on-click="_deleteAllClick">
              <iron-icon icon="arc:delete" slot="item-icon"></iron-icon>
              Delete all
            </paper-icon-item>
          </paper-listbox>
        </paper-menu-button>
      </div>
    </div>
    <template is="dom-if" if="[[querying]]">
      <paper-progress indeterminate></paper-progress>
    </template>
    <template is="dom-if" if="[[dataUnavailable]]">
      <p class="empty-info">The requests list is empty.</p>
      <p class="empty-info">Send a request from the request panel and it will appear here.</p>
    </template>

    <section class="selection-options" hidden$="[[listHidden]]">
      <p class="selection-label">Selected: [[selectedItems.length]]</p>
      <template is="dom-if" if="[[hasSelection]]">
        <paper-menu-button dynamic-align id="historyListMenu">
          <paper-icon-button icon="arc:more-vert" slot="dropdown-trigger"></paper-icon-button>
          <paper-listbox slot="dropdown-content" id="historyListMenuOptions">
            <paper-icon-item on-click="_exportSelected" data-action="export-selected-file">
              <iron-icon icon="arc:archive" slot="item-icon"></iron-icon>
              Save selected to file
            </paper-icon-item>
            <paper-icon-item on-click="_exportSelectedDrive" data-action="export-selected-drive">
              <iron-icon icon="arc:drive-color" slot="item-icon"></iron-icon>
              Save selected to Google Drive
            </paper-icon-item>
            <paper-icon-item data-action="delete-all" on-click="_deleteSelected">
              <iron-icon icon="arc:delete" slot="item-icon"></iron-icon>
              Delete selected
            </paper-icon-item>
          </paper-listbox>
        </paper-menu-button>
      </template>
      <div class="spacer"></div>
      <paper-input label="search" type="search" no-label-float></paper-input>
    </section>

    <history-panel-list
      hidden$="[[listHidden]]"
      requests="[[requests]]"
      list-type="[[listType]]"
      has-two-lines="[[_hasTwoLines]]"
      selected-items="{{selectedItems}}"
      on-list-items-threshold="loadNext"
      on-list-item-details="_onDetails"></history-panel-list>

    <bottom-sheet id="requestDetailsContainer" on-iron-overlay-opened="_resizeSheetContent" opened="{{detailsOpened}}">
      <paper-fab icon="arc:keyboard-arrow-right" data-action="load-request-detail" title="Load request" on-click="_loadRequestDetails"></paper-fab>
      <saved-request-detail
        id="requestDetails"
        is-history
        on-delete-request="_deleteRequestDetails"
        on-edit-request="_editRequestDetails"></saved-request-detail>
    </bottom-sheet>
    <bottom-sheet id="requestEditorContainer" on-iron-overlay-opened="_resizeSheetContent" opened="{{editorOpened}}">
      <h3>Save history request</h3>
      <saved-request-editor
        id="requestEditor"
        is-history
        on-cancel-request-edit="_cancelRequestEdit"
        on-save-request="_saveRequestEdit"></saved-request-detail>
    </bottom-sheet>

    <paper-toast id="noModel" class="error-toast" text="Model not found. Please, report an issue."></paper-toast>
    <paper-toast id="errorToast" class="error-toast" duration="5000"></paper-toast>
    <paper-toast id="revertError" class="error-toast" text="Unable to revert changes. Please, report an issue."></paper-toast>
    <paper-toast id="noExport" class="error-toast" text="Export module not found. Please, report an issue."></paper-toast>
    <paper-toast id="dataClearErrorToast" class="error-toast" text="Datasore delete error. Please report an issue"></paper-toast>
    <paper-toast id="driveSaved" text="Requests saved on Google Drive."></paper-toast>
    <paper-toast id="deleteToast" duration="7000">
      <paper-button class="revert-button" on-tap="revertDeleted">Revert</paper-button>
    </paper-toast>

    <paper-dialog id="dataClearDialog" on-iron-overlay-closed="_onClearDialogResult">
      <h2>Danger zone</h2>
      <p>This will remove all data from the data store. Without option to restore it.</p>
      <p>Maybe you should create a backup first?</p>
      <div class="buttons">
        <paper-button dialog-dismiss autofocus>Cancel</paper-button>
        <paper-button dialog-confirm class="action-button">Destroy</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
  /**
   * History panel screen for Advanced REST Client.
   *
   * ### Styling
   * `<history-panel>` provides the following custom properties and mixins for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--history-panel` | Mixin applied to the element | `{}`
   * `--arc-font-headline` | Mixin applied to the header | `{}`
   * `--arc-font-subhead` | Mixin applied to the subheader | `{}`
   * `--history-panel-loader` | Mixin applied to the loader element | `{}`
   * `--history-panel-list` | Mixin apllied to the list element | `{}`
   * `--history-panel-toast-revert-button` | Mixin appllied to the rever button | `{}`
   * `--warning-primary-color` | Main color of the warning messages | `#FF7043`
   * `--warning-contrast-color` | Contrast color for the warning color | `#fff`
   * `--error-toast` | Mixin applied to the error toast | `{}`
   * `--empty-info` | Mixin applied to the label rendered when no data is available. | `{}`
   * `--history-panel-fab-background-color` | Bg color of fab button | `--primary-color`
   * `--history-panel-bottom-sheet` | Mixin apllied to the `<bottom-sheet>` elements | `{}`
   *
   * @polymer
   * @customElement
   * @memberof UiElements
   * @demo demo/index.html
   * @appliesMixin ArcComponents.RequestsListMixin
   * @appliesMixin ArcComponents.HistoryListMixin
   */
  class HistoryPanel extends ArcComponents.HistoryListMixin(
    ArcComponents.RequestsListMixin(Polymer.Element)) {
    static get is() {
      return 'history-panel';
    }

    static get properties() {
      return {
        /**
         * List of requests that has been recently removed
         */
        _latestDeleted: Array,
        /**
         * Computed value, true if the requests lists is hidden.
         */
        listHidden: {
          type: Boolean,
          value: true,
          computed: '_computeListHidden(hasRequests, isSearch)'
        },

        /**
         * Selected items list.
         * @type {Array<Object>}
         */
        selectedItems: Array,
        /**
         * Computed value, true when the user made a selection on the list.
         */
        hasSelection: {type: Boolean, computed: '_computeHasSelection(selectedItems.length)'},
        /**
         * When true the editor panel is rendered
         */
        editorOpened: Boolean,
        /**
         * When true the details panel is rendered
         */
        detailsOpened: Boolean
      };
    }

    constructor() {
      super();
      this._navigateHandler = this._navigateHandler.bind(this);
      this._searchHandler = this._searchHandler.bind(this);
    }

    connectedCallback() {
      super.connectedCallback();
      this.addEventListener('navigate', this._navigateHandler);
      const input = this.shadowRoot.querySelector('paper-input[type="search"]');
      input.inputElement.addEventListener('search', this._searchHandler);
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      const input = this.shadowRoot.querySelector('paper-input[type="search"]');
      input.inputElement.removeEventListener('search', this._searchHandler);
      this.removeEventListener('navigate', this._navigateHandler);
    }

    /**
     * Notifies the list that the resize event occurred.
     * Should be called whhen content of the list changed but the list wasn't
     * visible at the time.
     */
    notifyResize() {
      const list = this.shadowRoot.querySelector('history-panel-list');
      if (list) {
        list.notifyResize();
      } else {
        console.warn('history-panel-list not in the DOM');
      }
    }
    /**
     * Computes value of the `listHidden` property.
     * List is hidden when no requests are found and it is not searching.
     * @param {Boolean} hasRequests
     * @param {Boolean} isSearch
     * @return {Boolean}
     */
    _computeListHidden(hasRequests, isSearch) {
      if (isSearch) {
        return false;
      }
      return !hasRequests;
    }
    /**
     * Handler for navigate action from the list
     */
    _navigateHandler() {
      if (this.detailsOpened) {
        this.detailsOpened = false;
      }
    }
    // Handles items delete event.
    _deleteSelected() {
      const data = this.selectedItems;
      if (!data.length) {
        return;
      }
      return this._delete(data);
    }
    // Deletes a request from the details panel.
    _deleteRequestDetails() {
      const data = [this.$.requestDetails.request];
      this.detailsOpened = false;
      return this._delete(data);
    }
    /**
     * Performs a delete action of request items.
     *
     * @param {Array<Object>} deleted List of deleted items.
     * @return {[type]} [description]
     */
    _delete(deleted) {
      const e = new CustomEvent('request-objects-deleted', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          type: 'history',
          items: deleted.map((item) => item._id)
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        this.$.noModel.opened = true;
        return;
      }
      return e.detail.result
      .then((updated) => {
        return Object.keys(updated)
        .map((id) => {
          return {
            _id: id,
            _rev: updated[id]
          };
        });
      })
      .then((deleted) => {
        this._latestDeleted = deleted;
        let msg;
        if (deleted.length === 1) {
          msg = 'The request has been removed.';
        } else {
          msg = deleted.length + ' requests has been removed.';
        }
        this.$.deleteToast.text = msg;
        this.$.deleteToast.opened = true;
      });
    }
    /**
     * Restores removed requests.
     * It does nothing if `_latestDeleted` is not set or empty.
     *
     * @return {Promise} A promise resolved when objects were restored
     */
    revertDeleted() {
      this.$.deleteToast.opened = false;
      const deleted = this._latestDeleted;
      if (!deleted || !deleted.length) {
        return Promise.resolve();
      }
      const e = new CustomEvent('request-objects-undeleted', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          type: 'history',
          items: deleted
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        this.$.noModel.opened = true;
        return Promise.reject(new Error('Model not found'));
      }
      return e.detail.result
      .catch((cause) => {
        this.$.revertError.opened = true;
        this._handleError(cause);
      });
    }
    /**
     * Forces selection menu to close.
     */
    _closeSelectionMenu() {
      const menu = this.shadowRoot.querySelector('#historyListMenu');
      if (!menu) {
        return;
      }
      menu.opened = false;
      const options = this.shadowRoot.querySelector('#historyListMenuOptions');
      if (!options) {
        return;
      }
      options.selected = -1;
    }
    /**
     * Calles `_exportItems()` with default destination (`file`)
     */
    _exportSelected() {
      this._exportItems('file');
    }
    /**
     * Calles `_exportItems()` with destination set to `drive`
     */
    _exportSelectedDrive() {
      this._exportItems('drive');
    }
    /**
     * Forces main menu to close.
     */
    _closeMainMenu() {
      this.$.mainMenu.opened = false;
      this.$.mainMenuOptions.selected = -1;
    }
    /**
     * Menu handler to export all project data to Drive
     */
    _onExportAllDrive() {
      this._closeMainMenu();
      this._exportAll('drive');
    }
    /**
     * Menu handler to export all project data to file
     */
    _onExportAll() {
      this._closeMainMenu();
      this._exportAll('file');
    }
    /**
     * Requests application to export all data to `destination`.
     * This works with `arc-data-export` element.
     *
     * @param {String} destination One of the supporting destinations
     * in `arc-data-export`.
     */
    _exportAll(destination) {
      const e = new CustomEvent('export-data', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          type: 'arc-export',
          destination,
          file: 'arc-history-export.json',
          data: {
            history: true
          }
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        this.$.noExport.opened = true;
        return;
      }
      e.detail.result.then(() => {
        if (destination === 'drive') {
          this.$.driveSaved.opened = true;
        }
      });
    }
    /**
     * Dispatches the `export-project` event with relevant data.
     *
     * @param {String} destination
     */
    _exportItems(destination) {
      this._closeSelectionMenu();
      const data = this.selectedItems.map((item) => this._resetHistoryObject(item));
      if (!data.length) {
        return;
      }
      const e = new CustomEvent('export-data', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          type: 'arc-export',
          destination,
          file: 'arc-history-export.json',
          kind: 'ARC#HistoryExport',
          data: {
            history: data
          }
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        this.$.noExport.opened = true;
        return;
      }
      e.detail.result.then(() => {
        if (destination === 'drive') {
          this.$.driveSaved.opened = true;
        }
      });
    }
    /**
     * Opens the request details applet with the request.
     * @param {CustomEvent} e
     */
    _onDetails(e) {
      this.$.requestDetails.request = e.detail.request;
      this.detailsOpened = true;
    }
    /**
     * Fires `navigate` event for currently loaded in the details request.
     */
    _loadRequestDetails() {
      this.dispatchEvent(new CustomEvent('navigate', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          base: 'request',
          type: this.type,
          id: this.$.requestDetails.request._id
        }
      }));
      this.detailsOpened = false;
    }

    _searchHandler(e) {
      const {value} = e.target;
      this.query(value);
    }
    /**
     * Handler for delete all menu option click.
     */
    _deleteAllClick() {
      this.$.mainMenu.opened = false;
      this.$.mainMenuOptions.selected = -1;
      this.$.dataClearDialog.opened = true;
    }
    /**
     * Called when delete datastore dialog is closed.
     * @param {CustomEvent} e
     */
    _onClearDialogResult(e) {
      if (!e.detail.confirmed) {
        return;
      }
      this._clearDatastore();
    }
    /**
     * Removes all data from the datastore and then fires
     */
    _clearDatastore() {
      const e = new CustomEvent('destroy-model', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          models: ['history']
        }
      });
      this.dispatchEvent(e);
      if (!e.detail.result) {
        this.$.dataClearErrorToast.opened = true;
        this._handleError(new Error('Model not found.'));
        return;
      }
      Promise.all(e.detail.result)
      .catch((cause) => {
        this.$.dataClearErrorToast.opened = true;
        this._handleError(cause);
      });
    }

    /**
     * Opens request details editor in place of the request details applet.
     */
    _editRequestDetails() {
      const request = Object.assign({}, this.$.requestDetails.request);
      this._resetHistoryObject(request);
      this.$.requestEditor.request = request;
      this.$.requestDetails.request = undefined;
      this.detailsOpened = false;
      this.editorOpened = true;
    }

    _resizeSheetContent(e) {
      const panel = e.target.querySelector(
          'saved-request-editor,saved-request-detail');
      if (panel && panel.notifyResize) {
        panel.notifyResize();
      }
    }

    _cancelRequestEdit() {
      this.editorOpened = false;
    }
    /**
     * Handler fro save request event from the editor.
     */
    _saveRequestEdit() {
      this.editorOpened = false;
      this.$.requestEditor.request = undefined;
    }

    _computeHasSelection(length) {
      return !!length;
    }

    /**
     * Fired when navigation was requested
     *
     * @event navigate
     * @param {String} base The base route. It's always `request`
     * @param {String} type Type of the request to open. It's always `history`
     * @param {String} id ID of the request to open.
     */
    /**
     * Fired when requests are to be deleted. Informs the model to delete items.
     *
     * @event request-objects-deleted
     * @param {Array} items List of ids to delete
     * @param {String} type Always `history-requests`
     */
    /**
     * Fired when the "revert" delete button has been used.
     * Informs the requests model to restore the data.
     *
     * @event request-objects-undeleted
     * @param {Array} items List of requests to delete
     * @param {String} type Always `history-requests`
     */
    /**
     * Dispatched when the user requested to clear the data.
     * @event destroy-model
     * @param {Array<String>} models
     */
    /**
     * Dispatched to export history data to file / drive
     *
     * @event export-data
     * @param {String} type Depending on user selection it can be `history`
     * to export all history data or `items-export` to export specific items.
     * @param {String} destination Either `drive` or `file`
     * @param {String} file Export file name
     * @param {String} kind For selection export, data kind.
     * @param {Object} items For selection export, data to export.
     */
  }
  window.customElements.define(HistoryPanel.is, HistoryPanel);
  </script>
</dom-module>
