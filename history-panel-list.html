<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../requests-list-mixin/requests-list-styles.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../http-method-label/http-method-label.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<dom-module id="history-panel-list">
  <template>
    <style include="requests-list-styles">
    :host {
      display: block;
      position: relative;
      @apply --layout-flex;
      @apply --layout-vertical;
      @apply --history-panel-list;
    };

    iron-list {
      flex: 1 1 auto;
      @apply --history-panel-list-list;
    }

    .url {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      font-size: 14px;
      @apply --history-menu-url-label;
    }

    http-method-label {
      margin-right: 12px;
      margin-bottom: 0;
      @apply --history-panel-list-method-label;
    }

    :host([list-type="comfortable"]) .list-action-button {
      height: 32px;
    }

    :host([list-type="compact"]) .list-action-button {
      height: 24px;
    }
    </style>
    <iron-list items="[[requests]]" id="list" selected-items="{{selectedItems}}" multi-selection>
      <template>
        <div data-index$="[[index]]" title$="[[item.url]]">
          <template is="dom-if" if="[[item.hasHeader]]">
            <div class="history-group-header">[[item.header]]</div>
          </template>
          <paper-icon-item on-click="_toggleSelection">
            <paper-checkbox slot="item-icon" checked="{{selected}}"></paper-checkbox>
            <http-method-label method="[[item.method]]"></http-method-label>
            <paper-item-body two-line$="[[_hasTwoLines]]">
              <div class="url">[[item.url]]</div>
              <div secondary>[[item.timeLabel]]</div>
              <paper-ripple></paper-ripple>
            </paper-item-body>
            <paper-button class="list-action-button secondary-action" data-action="item-detail" on-click="_requestDetails">Details</paper-button>
            <paper-button class="list-action-button main-action" data-action="open-item" on-click="_navigateItem" raised>Open</paper-button>
          </paper-icon-item>
        </div>
      </template>
    </iron-list>
    <iron-scroll-threshold
      id="scrollTheshold"
      lower-threshold="[[threshold]]"
      on-lower-threshold="_thresholdHandler"
      scroll-target="[[_scrollTarget]]"></iron-scroll-threshold>
  </template>
  <script>
  /**
   * `history-panel-list`
   *
   * ## Styling
   *
   * `<history-panel-list>` provides the following custom properties and mixins for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--history-panel-list` | Mixin applied to this elment | `{}`
   *
   * @customElement
   * @polymer
   * @demo demo/index.html
   * @memberof ApiElements
   */
  class HistoryPanelList extends Polymer.Element {
    static get is() {
      return 'history-panel-list';
    }
    static get properties() {
      return {
        requests: Array,
        /**
         * Changes information density of list items.
         * By default it uses material's peper item with two lines (72px heigth)
         * Possible values are:
         *
         * - `default` or empty - regular list view
         * - `comfortable` - enables MD single line list item vie (52px heigth)
         * - `compact` - enables list that has 40px heigth (touch recommended)
         */
        listType: {
          type: String,
          reflectToAttribute: true,
          observer: '_updateListStyles'
        },
        /**
         * A list lower treshold when the `history-list-threshold` will be
         * fired. It should informa the app that the user nearly reached
         * the end of the list and new items should be loaded.
         */
        threshold: {
          type: Number,
          value: 120
        },
        /**
         * Scroll target for `iron-scroll-threshold`.
         * This is set in connectedCallback as the DOM has to be initialized
         * before setting this property.
         * @type {Element}
         */
        _scrollTarget: Object,
        // List of selected items on the list.
        selectedItems: {
          type: Array,
          notify: true
        }
      };
    }

    static get observers() {
      return ['_requestsChanged(requests.*)'];
    }

    connectedCallback() {
      super.connectedCallback();
      this._scrollTarget = this.$.list;
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      this._scrollTarget = undefined;
    }

    /**
     * Notifies the list that the resize event occurred.
     * Should be called whhen content of the list changed but the list wasn't
     * visible at the time.
     */
    notifyResize() {
      this.$.list.notifyResize();
    }

    _updateListStyles() {
      this.updateStyles({});
      this.notifyResize();
    }

    _thresholdHandler(e) {
      if (this.__ignoreTreshold) {
        e.target.clearTriggers();
        return;
      }
      const r = this.requests;
      if (!r || !r.length) {
        return;
      }
      this.dispatchEvent(new CustomEvent('list-items-threshold'));
    }

    _requestsChanged(record) {
      if (!this.__ignoreTreshold && record &&
        (record.path === 'requests.length' || record.path === 'requests')) {
        this.$.scrollTheshold.clearTriggers();
        this.__ignoreTreshold = true;
        Polymer.RenderStatus.afterNextRender(this, () => {
          this.__ignoreTreshold = false;
        });
      }
    }

    _requestDetails(e) {
      e.preventDefault();
      e.stopPropagation();

      this.dispatchEvent(new CustomEvent('list-item-details', {
        detail: {
          request: e.model.get('item')
        }
      }));
    }

    _navigateItem(e) {
      e.preventDefault();
      e.stopPropagation();

      const id = e.model.get('item._id');
      this.dispatchEvent(new CustomEvent('navigate', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          base: 'request',
          type: this.type,
          id
        }
      }));
    }

    _toggleSelection(e) {
      this.$.list.toggleSelectionForIndex(e.model.get('index'));
    }
  }
  window.customElements.define(HistoryPanelList.is, HistoryPanelList);
  </script>
</dom-module>
